<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quantile Recalibration for Regression Models • recalibratiNN</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Quantile Recalibration for Regression Models">
<meta property="og:description" content="The recalibratiNN R package enables users to enhance the calibration of regression models. It offers both global and local visualization tools to diagnose calibration. It also provides a recalibration method inspired by Approximate Bayesian Computation (ABC). This methods enable users to adjust model predictions, improving alignment with observed data. By allowing for global and local recalibration, the package ensures precise adjustments tailored to specific data subsets or regions of interest.">
<meta property="og:image" content="/reference/figures/recalibratiNN.png">
<meta property="og:image:alt" content="Gaussian Neural Networks">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">recalibratiNN</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmusso86/recalibratiNN/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="recalibratinn-">recalibratiNN <img src="reference/figures/recalibratiNN.png" align="right" height="200" style="float:right; height:200px;"><a class="anchor" aria-label="anchor" href="#recalibratinn-"></a>
</h1></div>
<p>This package provides a post processing method to recalibrate fitted Gaussian models.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the current version of recalibratiNN with:</p>
<div class="section level3">
<h3 id="when-on-cran">When on CRAN<a class="anchor" aria-label="anchor" href="#when-on-cran"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"recalibratiNN"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmusso86/recalibratiNN" class="external-link">recalibratiNN</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="from-github">From GitHub<a class="anchor" aria-label="anchor" href="#from-github"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"cmusso86/recalibratiNN"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmusso86/recalibratiNN" class="external-link">recalibratiNN</a></span><span class="op">)</span></span></code></pre></div>
<p>Alternately, one can use the <code>pacman</code> package to both install and download.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/trinker/pacman" class="external-link">pacman</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu">p_load_current_gh</span><span class="op">(</span><span class="st">"cmusso86/recalibratiNN"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── R CMD build ─────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; * checking for file ‘/private/var/folders/rp/h9_9qkdd7c57z9_hytk4306h0000gn/T/RtmpuXx5aH/remotes196d18e01849/cmusso86-recalibratiNN-6cc5d2e/DESCRIPTION’ ... OK</span></span>
<span><span class="co">#&gt; * preparing ‘recalibratiNN’:</span></span>
<span><span class="co">#&gt; * checking DESCRIPTION meta-information ... OK</span></span>
<span><span class="co">#&gt; * checking for LF line-endings in source and make files and shell scripts</span></span>
<span><span class="co">#&gt; * checking for empty or unneeded directories</span></span>
<span><span class="co">#&gt; * building ‘recalibratiNN_0.2.1.tar.gz’</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="understanding-calibrationmiscalibration">Understanding calibration/miscalibration<a class="anchor" aria-label="anchor" href="#understanding-calibrationmiscalibration"></a>
</h2>
<p>This example illustrates a common issue of miscalibration. To demonstrate this, we created a heteroscedastic model and fitted it using simple linear regression for visualization purposes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## basic artificial model example</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">split</span> <span class="op">&lt;-</span> <span class="fl">0.8</span></span>
<span></span>
<span><span class="co"># Auxiliary functions</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="fl">10</span> <span class="op">+</span> <span class="fl">5</span><span class="op">*</span><span class="va">x1</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sigma_v</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="fl">30</span><span class="op">*</span><span class="va">x1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># generating heterocedastic data (true model)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fu">mu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">sigma_v</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># slipting data </span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">split</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">split</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">x_cal</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">split</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span><span class="va">y_cal</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">split</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># fitting a simple linear model</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y_train</span> <span class="op">~</span> <span class="va">x_train</span><span class="op">)</span></span></code></pre></div>
<p>In the graph below, you can observe the true mean, the data points, and the regression line. The linear model, represented by a dashed black line, consistently underestimates the mean for both small and large values of <span class="math inline"><em>x</em></span>. Additionally, it overestimates the variance at lower values of <span class="math inline"><em>x</em></span>, as indicated by all points falling within the confidence interval (CI). Conversely, at higher values of <span class="math inline"><em>x</em></span>, the model underestimates the true variance. These discrepancies highlight the model’s inability to accurately quantify uncertainty, showcasing it as an example of a miscalibrated model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu">p_load</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu">p_load_gh</span><span class="op">(</span><span class="st">"AllanCameron/geomtextpath"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use predict to get the confidence intervals</span></span>
<span><span class="va">data_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, </span>
<span>                        newdata<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_train<span class="op">=</span><span class="va">x_cal</span><span class="op">)</span>, </span>
<span>                        interval <span class="op">=</span> <span class="st">"prediction"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>x_cal<span class="op">=</span><span class="va">x_cal</span>, </span>
<span>                y_cal<span class="op">=</span><span class="va">y_cal</span>,</span>
<span>          CI<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">y_cal</span><span class="op">&lt;=</span><span class="va">upr</span><span class="op">&amp;</span><span class="va">y_cal</span><span class="op">&gt;=</span><span class="va">lwr</span>, <span class="st">"in"</span>, <span class="st">"out"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">data_predict</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">x_cal</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span><span class="va">x_cal</span>, <span class="va">y_cal</span>, color<span class="op">=</span><span class="va">CI</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_labelline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span> y<span class="op">=</span><span class="fu">mu</span><span class="op">(</span><span class="va">x_cal</span><span class="op">)</span>, label<span class="op">=</span><span class="st">"True Mean"</span> <span class="op">)</span>, </span>
<span>                 size<span class="op">=</span><span class="fl">1.8</span>, hjust<span class="op">=</span><span class="op">-</span><span class="fl">0.01</span>, linewidth<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">"red"</span> <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span> y<span class="op">=</span><span class="va">y_cal</span> <span class="op">)</span>, color<span class="op">=</span><span class="st">"black"</span>,se<span class="op">=</span><span class="cn">F</span>,</span>
<span>                   method<span class="op">=</span><span class="st">"lm"</span>, formula<span class="op">=</span><span class="va">y</span><span class="op">~</span><span class="va">x</span>,linetype<span class="op">=</span><span class="st">"dashed"</span> <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span><span class="st">"IC 95%"</span>, values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#00822e"</span>, <span class="st">"#2f1d86"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span>
<span>   </span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="reference/figures/disp.png" alt="Model coverage, true mean (red) and estimated mean (black dashed line)." width="80%"><p class="caption">
Model coverage, true mean (red) and estimated mean (black dashed line).
</p>
</div>
</div>
<div class="section level2">
<h2 id="using-the-recalibratinn-package">Using the recalibratiNN package<a class="anchor" aria-label="anchor" href="#using-the-recalibratinn-package"></a>
</h2>
<p>In real-world scenarios, especially with higher-dimensional models, evaluating miscalibration as described above is not feasible . A widely used method for assessing global calibration in such cases is through the analysis of Probability Integral Transform (PIT) values. PIT values quantify the estimated cumulative probability of the observed values within the predicted distribution. This approach involves generating a histogram or density plot of the cumulative distribution functions predicted by the model for each observation. A well-specified model will yield a distribution that closely resembles a Uniform distribution.</p>
<div class="section level3">
<h3 id="observing-global-calibrationmiscalibration">Observing global calibration/miscalibration<a class="anchor" aria-label="anchor" href="#observing-global-calibrationmiscalibration"></a>
</h3>
<p>To obtain PIT values for the fitted model using a calibration set, we first use the <code>PIT_values()</code> function. This requires some preliminary calculations that will be used as arguments: predicted values of the fitted model for new observations (using predict); the Mean Squared Errors for the validation set, which in this context is referred to as the ‘calibration set’.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmusso86/recalibratiNN" class="external-link">recalibratiNN</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># predictions for the calibration set</span></span>
<span><span class="va">y_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_train <span class="op">=</span> <span class="va">x_cal</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># MSE from calibration set</span></span>
<span><span class="va">MSE_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_hat</span> <span class="op">-</span> <span class="va">y_cal</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># a little different from MSE from training set</span></span>
<span></span>
<span><span class="co"># USE tha recalibratiNN::PIT_local() to calculate the pit-values.</span></span>
<span></span>
<span><span class="va">pit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/PIT_global.html">PIT_global</a></span><span class="op">(</span>ycal<span class="op">=</span><span class="va">y_cal</span>, </span>
<span>                  yhat<span class="op">=</span><span class="va">y_hat</span>, </span>
<span>                  mse<span class="op">=</span><span class="va">MSE_cal</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pit</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.04551257 0.42522358 0.81439164 0.69119416 0.44043239 0.99770918</span></span></code></pre></div>
<p>Following these steps, you can then visualize the histogram and assess its fit to a uniform distribution using the <code><a href="reference/gg_PIT_global.html">gg_PIT_global()</a></code> function. For additional customization options, refer to the function’s documentation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/gg_PIT_global.html">gg_PIT_global</a></span><span class="op">(</span><span class="va">pit</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/ggP.png" width="80%" style="display: block; margin: auto;"></p>
<p>In this instance, as we are fitting a linear model (<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>) to a heteroscedastic model it is expected that the histogram indicated miscalibration. Additionally, the image includes the p-value from the hypothesis testing using the Kolmogorov-Smirnov test, conducted with the <code><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test()</a></code> function from the stats package.</p>
<p>It is also to use other visualization function of the package with the <code>gg_CD_global</code>. This graph shows the cumulative predictive distribution in the x-axis versus the empirical cumulative distribution and require four parameters.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/gg_CD_global.html">gg_CD_global</a></span><span class="op">(</span><span class="va">pit</span>,</span>
<span>             <span class="va">y_cal</span>, </span>
<span>             <span class="va">y_hat</span>, </span>
<span>             <span class="va">MSE_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/ggQ.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="local-calibration">Local Calibration<a class="anchor" aria-label="anchor" href="#local-calibration"></a>
</h3>
<p>However, relying solely on global calibration can be deceptive. A model may appear well-calibrated on a global scale, yet exhibit significant issues on a local level. For example, the model in question demonstrates a coverage close to 95%, aligning with the expected 95% confidence interval. Nonetheless, a closer inspection reveals that the distribution of errors is not uniform. In certain regions, the model consistently exhibits greater inaccuracies, indicating systematic errors.</p>
<p>The observed disparities are evident in the graphs below. To analyze these, we first compute local PIT values using the <code><a href="reference/PIT_local.html">PIT_local()</a></code> function. This function divides the covariate space into ‘n’ clusters, with a default of 6, using a k-means algorithm. It then identifies neighbors around the centroids of each cluster.</p>
<p>Observing this graph, we notice the model is uncalibrated in different ways thoughout the covariates space.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculating local PIT </span></span>
<span><span class="va">pit_local</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/PIT_local.html">PIT_local</a></span><span class="op">(</span>xcal <span class="op">=</span> <span class="va">x_cal</span>, </span>
<span>                       ycal<span class="op">=</span> <span class="va">y_cal</span>, </span>
<span>                       yhat <span class="op">=</span> <span class="va">y_hat</span>, </span>
<span>                       mse <span class="op">=</span> <span class="va">MSE_cal</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/gg_PIT_local.html">gg_PIT_local</a></span><span class="op">(</span><span class="va">pit_local</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/plot1PL.png" width="80%" style="display: block; margin: auto;"></p>
<p>In the initial segment, the model overestimates the variance while underestimating the mean. In contrast, the middle region shows better calibration, with the model’s predictions aligning more closely with observed values. Towards the end, however, it underestimates the variance. These distinct behaviors in different partitions of the data clearly suggest that the model would benefit from local calibration, as each section exhibits unique calibration needs.</p>
<p>Alternatively you can observe the local miscalibration in the QQ-graph.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/gg_CD_local.html">gg_CD_local</a></span><span class="op">(</span><span class="va">pit_local</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/gg_CD_local.html">gg_CD_local</a></span><span class="op">(</span><span class="va">pit_local</span>, facet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/plotQL1.png" width="80%" style="display: block; margin: auto;"><img src="reference/figures/plotQL2.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="recalibration">Recalibration<a class="anchor" aria-label="anchor" href="#recalibration"></a>
</h3>
<p>This Quantile recalibration method produces Monte Carlo samples from a predictive distribution, which is unknown yet expected to be more calibrated. This process also yields recalibrated estimates of the weighted mean and variance.</p>
<p>The <code><a href="reference/recalibrate.html">recalibrate()</a></code> function implements the method described by Torres et al. (2023), drawing inspiration from Approximate Bayesian Computation. This method can be applied globally or locally. In our heteroscedastic example, local calibration shows superior performance. It employs a KNN algorithm to identify the nearest neighbors from the calibration set to the new or test set provided.</p>
<p>To execute recalibration, it’s essential to supply the global PIT values, irrespective of the recalibration type, along with the Mean Squared Error of the calibration set. The neighbor search can be conducted at the covariate level, at any intermediate layer (as in a Neural Network), or even at the output layer.</p>
<p>The function calculates the PIT values and employs the Inverse Transform Theorem to generate recalibrated samples. By default, the size of the vicinity is set at 10% of the calibration set, but this can be customized using the p_neighbours argument.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># new data </span></span>
<span><span class="va">x_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y_hat_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>                       x_train<span class="op">=</span><span class="va">x_new</span><span class="op">)</span></span>
<span>                     <span class="op">)</span></span>
<span></span>
<span><span class="co"># recalibration</span></span>
<span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/recalibrate.html">recalibrate</a></span><span class="op">(</span>yhat_new <span class="op">=</span> <span class="va">y_hat_new</span>,</span>
<span>                   space_new <span class="op">=</span> <span class="va">x_new</span>,</span>
<span>                   space_cal <span class="op">=</span> <span class="va">x_cal</span>,</span>
<span>                   pit_values <span class="op">=</span> <span class="va">pit</span>,</span>
<span>                   mse <span class="op">=</span> <span class="va">MSE_cal</span>,</span>
<span>                   type <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>                   p_neighbours<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>Now, we possess a list of new parameters and Monte Carlo samples from a predictive distribution that is expected to be calibrated. Although the exact form of this new distribution is unknown, we can estimate its parameters.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_yhat</span> <span class="op">&lt;-</span> <span class="va">rec</span><span class="op">$</span><span class="va">y_hat_calibrated</span> <span class="co"># calibrated means</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="bonus-section-checking-if-it-worked">Bonus section: checking if it worked<a class="anchor" aria-label="anchor" href="#bonus-section-checking-if-it-worked"></a>
</h1>
<p>To look for more examples of successful application of this method in the calibration, please refer to Torres et. al (2023).</p>
<p>For this exercise, we’ll deviate slightly from standard practices and assess the calibration on our test set, referred to here as the ‘new set.’ This deviation is permissible in our artificial example because we know the true model/process that generated the data. Consequently, we can compute the empirical PIT values to determine if the predictions are now better calibrated. It’s important to note that this is purely an educational exercise; in real-world scenarios, such an approach might not be feasible. Additionally, this specific evaluation method is not implemented in the package and is presented here solely to illustrate its effectiveness in this scenario.</p>
<p>Note that since we dont know the real distribution, we can only calculate the empirical PIT-values, and not the ones provided ny the Inverse Transform Theorem.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># what youd be the real observations in this example</span></span>
<span><span class="va">y_new_real</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">5</span>, </span>
<span>                    <span class="fu">mu</span><span class="op">(</span><span class="va">x_new</span><span class="op">)</span>, </span>
<span>                    <span class="fu">sigma_v</span><span class="op">(</span><span class="va">x_new</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># retrieving the weighted samples</span></span>
<span><span class="va">y_hat_recalib</span> <span class="op">&lt;-</span> <span class="va">rec</span><span class="op">$</span><span class="va">y_samples_calibrated_wt</span></span>
<span></span>
<span><span class="co"># empirical p-value distribution</span></span>
<span><span class="va">pit_new</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_new_real</span><span class="op">)</span>, <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_hat_recalib</span><span class="op">[</span><span class="va">.</span>,<span class="op">]</span> <span class="op">&lt;=</span><span class="va">y_new_real</span><span class="op">[</span><span class="va">.</span><span class="op">]</span> <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/gg_PIT_global.html">gg_PIT_global</a></span><span class="op">(</span><span class="va">pit_new</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-20-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>We see now that the pit-values are approximately uniform, at least globally. Bellow, we also see that the local calibration is improved.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_neighbours</span> <span class="op">&lt;-</span> <span class="fl">800</span></span>
<span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span></span>
<span><span class="co"># calculating centroids</span></span>
<span><span class="va">cluster_means_cal</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">x_new</span>, <span class="va">clusters</span><span class="op">)</span><span class="op">$</span><span class="va">centers</span></span>
<span>  <span class="va">cluster_means_cal</span> <span class="op">&lt;-</span> <span class="va">cluster_means_cal</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">cluster_means_cal</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span>  </span>
<span><span class="co"># finding neighbours</span></span>
<span><span class="va">knn_cal</span> <span class="op">&lt;-</span> <span class="fu">RANN</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RANN/man/nn2.html" class="external-link">nn2</a></span><span class="op">(</span><span class="va">x_new</span>, <span class="va">cluster_means_cal</span>,  k<span class="op">=</span><span class="va">n_neighbours</span><span class="op">)</span><span class="op">$</span><span class="va">nn.idx</span></span>
<span></span>
<span></span>
<span><span class="co"># geting corresponding ys (real and estimated)</span></span>
<span><span class="va">y_new_local</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">knn_cal</span><span class="op">)</span>,  <span class="op">~</span><span class="va">y_new_real</span><span class="op">[</span><span class="va">knn_cal</span><span class="op">[</span><span class="va">.</span>,<span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_hat_local</span> <span class="op">&lt;-</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">knn_cal</span><span class="op">)</span>,  <span class="op">~</span><span class="va">y_hat_recalib</span><span class="op">[</span><span class="va">knn_cal</span><span class="op">[</span><span class="va">.</span>,<span class="op">]</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># calculate pit_local</span></span>
<span></span>
<span><span class="va">pits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="fl">6</span>, ncol<span class="op">=</span><span class="fl">800</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">clusters</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pits</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_new_local</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="op">~</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_hat_local</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">.</span>,<span class="op">]</span> <span class="op">&lt;=</span> <span class="va">y_new_local</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">.</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">pits</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">value</span>,</span>
<span>                   color<span class="op">=</span><span class="va">name</span>,</span>
<span>                   fill<span class="op">=</span><span class="va">name</span><span class="op">)</span>,</span>
<span>               alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span>               bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Set2"</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Set2"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"After Local Calibration"</span>,</span>
<span>       subtitle<span class="op">=</span> <span class="st">"It looks so much better!!"</span>,</span>
<span>       x<span class="op">=</span><span class="st">"PIT-values"</span>, y<span class="op">=</span><span class="st">"Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-21-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/cmusso86/recalibratiNN/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/cmusso86/recalibratiNN/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing recalibratiNN</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Carolina Musso <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-8107-6458" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Ricardo Torres <br><small class="roles"> Contributor, author </small> <a href="https://orcid.org/0009-0000-9100-7125" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Carolina Musso, Ricardo Torres.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
